<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>課文朗讀檢核系統 (含注音)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- 引入 pinyin-pro 用於自動注音 -->
    <script src="https://unpkg.com/pinyin-pro"></script>
    <!-- 引入 Tesseract.js 用於圖片文字辨識 (OCR) -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <!-- 引入 Mammoth.js 用於 Word (.docx) 文字讀取 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif; overscroll-behavior: none; }
        
        /* --- 核心渲染樣式 --- */
        .char-box {
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            background: transparent;
            transition: all 0.2s ease;
            height: 3.2em; /* 稍微增加基礎高度 */
            padding: 2px 1px 0 1px; /* 增加上方內距 */
            text-indent: 0;
            border: 1px solid transparent;
            z-index: 10;
            /* 絕對禁止在字元內部換行或分頁 */
            page-break-inside: avoid;
            break-inside: avoid;
            -webkit-column-break-inside: avoid;
        }
        
        .char-box:hover { background-color: #f3f4f6; }

        .char {
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto; 
            min-width: 1.1em;
            height: 100%;
            font-size: 1em; 
            line-height: 1.2;
            color: #1f2937;
            font-weight: 500;
        }

        .zhuyin {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 0.4em; 
            color: #4b5563;
            margin-left: 2px; 
            font-family: system-ui, -apple-system, sans-serif; 
            line-height: 1.1;
            width: 1.2em; 
            position: relative;
        }

        .z-char {
            display: block;
            position: relative;
            height: 1.25em;
            width: 1em;
            text-align: center;
            line-height: 1.25;
            white-space: nowrap;
        }

        .z-char.light-dot {
            height: 0.4em;
            line-height: 0.4em;
            margin-bottom: -0.1em;
            font-size: 1.2em;
            z-index: 1;
            position: relative;
            top: 0;
        }

        .z-tone {
            position: absolute;
            right: -0.9em; 
            top: -0.2em;    
            width: 1em;
            height: 1em;
            text-align: center;
            font-weight: bold;
            pointer-events: none;
            transform: scale(1.2);
            font-family: system-ui, sans-serif;
        }

        .hide-zhuyin .zhuyin { display: none; width: 0; margin-left: 0; opacity: 0; }
        .hide-zhuyin .char-box { padding: 0 1px; }
        
        .segment-wrapper {
            margin-bottom: 2rem;
            position: relative;
            line-height: 2.2;
            word-wrap: break-word;
            /* 預設不強制分頁設定，由 JS 動態控制 */
        }

        .reading-active {
            background-color: #fde047 !important;
            color: #000; 
            transform: scale(1.15); 
            font-weight: 700;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15); 
            z-index: 30; 
            border-radius: 6px;
        }
        
        .reading-past .char { color: #94a3b8; }
        .hover-word .char-box:hover { background-color: #dcfce7; transform: scale(1.2); font-weight: bold; color: #166534; z-index: 40; }
        .edit-mode-active .char-box { border: 1px dashed #cbd5e1; }
        .edit-mode-active .char-box:hover { border-color: #3b82f6; background-color: #eff6ff; cursor: text; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { animation: slideIn 0.3s ease-out forwards; }
        .toast.hiding { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .library-card { transition: all 0.2s ease; }
        .library-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #a5b4fc; }

        .segment-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; touch-action: none; }
        .drawing-mode-active .segment-canvas { pointer-events: auto; cursor: crosshair; }
        .drawing-mode-active .char-box { pointer-events: none; } 

        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; padding: 0; overflow: hidden; border-radius: 50%; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 2px solid #e2e8f0; }

        @media print {
            body * { visibility: hidden; }
            #content-container, #content-container * { visibility: visible; }
            #content-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white !important; display: block !important; }
            .segment-wrapper { display: block !important; page-break-inside: avoid; }
            .char-box { page-break-inside: avoid !important; break-inside: avoid !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden relative">

    <header class="bg-white border-b border-slate-200 p-4 shadow-sm z-20 shrink-0">
        <div class="max-w-7xl mx-auto flex flex-wrap lg:flex-nowrap items-center justify-between gap-4">
            <div class="flex items-center gap-3 w-full lg:w-auto justify-between lg:justify-start">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white"><i data-lucide="book-open-check" class="w-6 h-6"></i></div>
                    <h1 class="text-xl font-bold text-slate-800 hidden sm:block">課文朗讀檢核系統</h1>
                </div>
                <div class="flex items-center gap-2 lg:hidden">
                     <button onclick="window.toggleZhuyin()" id="btn-toggle-zhuyin-mobile" class="p-2 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-lg font-bold">注音</button>
                     <button onclick="window.toggleDrawingMode()" id="drawing-toggle-btn-mobile" class="p-2 bg-white text-slate-600 border border-slate-300 rounded-lg"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                     <button onclick="window.toggleSettingsModal()" class="p-2 bg-indigo-600 text-white rounded-lg"><i data-lucide="settings" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-2 w-full lg:w-auto justify-start lg:justify-end overflow-x-auto no-scrollbar pb-1 lg:pb-0">
                <button onclick="window.toggleImportPanel()" class="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-lg text-sm font-medium border border-indigo-200 whitespace-nowrap"><i data-lucide="file-up" class="w-4 h-4"></i>匯入</button>
                <button onclick="window.toggleLibraryPanel()" class="flex items-center gap-1.5 px-3 py-1.5 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-lg text-sm font-medium border border-amber-200 whitespace-nowrap"><i data-lucide="library" class="w-4 h-4"></i>教材庫</button>
                <button onclick="window.toggleZhuyin()" id="btn-toggle-zhuyin" class="flex items-center gap-1.5 px-3 py-1.5 bg-sky-50 text-sky-600 hover:bg-sky-100 rounded-lg text-sm font-medium border border-sky-200 whitespace-nowrap transition-colors"><i data-lucide="eye" class="w-4 h-4"></i>顯示注音</button>
                <button onclick="window.toggleEditMode()" id="btn-edit-mode" class="flex items-center gap-1.5 px-3 py-1.5 bg-white text-slate-600 hover:text-blue-600 rounded-lg text-sm font-medium border border-slate-300 hover:border-blue-300 whitespace-nowrap transition-colors"><i data-lucide="edit-3" class="w-4 h-4"></i>編輯</button>
                <button onclick="window.togglePracticeMode()" id="practice-toggle-btn" class="flex items-center gap-1.5 px-3 py-1.5 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-lg text-sm font-medium border border-emerald-200 shadow-sm whitespace-nowrap"><i data-lucide="mic" class="w-4 h-4"></i>學生朗讀</button>
                <div class="h-6 w-px bg-slate-200 mx-1 hidden lg:block"></div>
                <button onclick="window.toggleDrawingMode()" id="drawing-toggle-btn" class="hidden lg:flex items-center gap-1 px-3 py-1.5 bg-white text-slate-600 hover:text-indigo-600 rounded-lg border border-slate-300 hover:border-indigo-300 transition-colors whitespace-nowrap"><i data-lucide="pencil" class="w-4 h-4"></i><span>筆記</span></button>
                <div class="flex items-center gap-1 bg-white px-2 py-1 rounded border border-slate-300">
                    <button onclick="window.setClickMode('sentence')" id="btn-mode-sentence" class="p-1.5 rounded transition-colors" title="整句"><i data-lucide="text-select" class="w-4 h-4"></i></button>
                    <button onclick="window.setClickMode('phrase')" id="btn-mode-phrase" class="p-1.5 rounded transition-colors" title="分句"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                    <div class="w-px h-4 bg-slate-200 mx-1"></div>
                    <button onclick="window.setClickMode('word')" id="btn-mode-word" class="p-1.5 rounded transition-colors" title="單字"><i data-lucide="mouse-pointer-2" class="w-4 h-4"></i></button>
                    <button onclick="window.setClickMode('silent')" id="btn-mode-silent" class="p-1.5 rounded transition-colors" title="指讀"><i data-lucide="mouse-pointer-click" class="w-4 h-4"></i></button>
                </div>
                <button onclick="window.toggleSettingsModal()" class="hidden lg:flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg shadow-md transition-colors font-medium whitespace-nowrap">
                    <i data-lucide="settings" class="w-4 h-4"></i> 設定
                </button>
            </div>
        </div>
    </header>

    <div id="drawing-toolbar" class="hidden w-full bg-slate-50 border-b border-slate-200 p-3 flex flex-wrap justify-center items-center gap-3 z-30 shrink-0 animate-in slide-in-from-top-2">
        <div class="flex bg-white border border-slate-200 p-1 rounded-lg">
            <button onclick="window.setTool('pen')" id="tool-pen" class="p-2 rounded-md bg-indigo-50 text-indigo-600 shadow-sm transition-all" title="畫筆"><i data-lucide="pen-tool" class="w-5 h-5"></i></button>
            <button onclick="window.setTool('highlighter')" id="tool-highlighter" class="p-2 rounded-md text-slate-500 hover:text-indigo-600 hover:bg-slate-50 transition-all" title="螢光筆"><i data-lucide="highlighter" class="w-5 h-5"></i></button>
            <button onclick="window.setTool('eraser')" id="tool-eraser" class="p-2 rounded-md text-slate-500 hover:text-indigo-600 hover:bg-slate-50 transition-all" title="橡皮擦"><i data-lucide="eraser" class="w-5 h-5"></i></button>
        </div>
        <div class="w-px h-8 bg-slate-200"></div>
        <div class="flex items-center gap-1.5">
            <button onclick="window.setColor('#ef4444')" class="w-6 h-6 rounded-full bg-red-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-slate-400"></button>
            <button onclick="window.setColor('#3b82f6')" class="w-6 h-6 rounded-full bg-blue-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-slate-400"></button>
            <button onclick="window.setColor('#000000')" class="w-6 h-6 rounded-full bg-black hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-slate-400"></button>
            <button onclick="window.setColor('#facc15')" class="w-6 h-6 rounded-full bg-yellow-400 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-slate-400"></button>
            <button onclick="window.setColor('#4ade80')" class="w-6 h-6 rounded-full bg-green-400 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-slate-400"></button>
            <div class="relative w-6 h-6 rounded-full overflow-hidden hover:scale-110 transition-transform border border-slate-300 group" title="自訂顏色">
                <input type="color" id="color-picker" onchange="window.setColor(this.value)" value="#ef4444" class="absolute inset-0 w-full h-full p-0 border-none cursor-pointer">
                <div class="absolute inset-0 pointer-events-none flex items-center justify-center bg-white/20 group-hover:bg-transparent"><i data-lucide="plus" class="w-3 h-3 text-slate-500"></i></div>
            </div>
        </div>
        <div class="w-px h-8 bg-slate-200"></div>
        <div class="flex items-center gap-2 bg-white border border-slate-200 px-2 py-1 rounded-lg" title="筆畫粗細">
            <i data-lucide="circle" class="w-2 h-2 text-slate-400"></i>
            <input type="range" id="size-slider" min="1" max="30" value="2" class="w-20 accent-indigo-600 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="window.setLineWidth(this.value)">
            <i data-lucide="circle" class="w-4 h-4 text-slate-400"></i>
        </div>
        <div class="w-px h-8 bg-slate-200"></div>
        <div class="flex gap-2">
            <div class="flex bg-white border border-slate-200 p-1 rounded-lg">
                <button onclick="window.undo()" id="tool-undo" class="p-1.5 rounded-md text-slate-400 hover:text-indigo-600 hover:bg-slate-50 transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="上一步"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
                <button onclick="window.redo()" id="tool-redo" class="p-1.5 rounded-md text-slate-400 hover:text-indigo-600 hover:bg-slate-50 transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="下一步"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
            </div>
            <button onclick="window.clearAllCanvas()" class="p-2 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-red-500 hover:bg-red-50 transition-colors shadow-sm" title="全部清除"><i data-lucide="trash" class="w-5 h-5"></i></button>
            <button onclick="window.downloadNote()" class="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded-lg shadow-md transition-colors" title="下載筆記 PDF"><i data-lucide="download" class="w-4 h-4"></i> <span class="hidden sm:inline">下載</span></button>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center p-4 transition-opacity" onclick="if(event.target === this) window.closeEditModal()">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="edit-3" class="w-5 h-5 text-indigo-500"></i> 編輯文字內容</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">國字</label><input type="text" id="edit-char-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xl text-center"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">注音 (包含聲調)</label><input type="text" id="edit-zhuyin-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xl text-center" placeholder="例如: ㄨㄛˇ"><p class="text-xs text-slate-400 mt-1">提示：輕聲符號請輸入在最前面或最後面（如：˙ㄉㄜ 或 ㄉㄜ˙）</p></div>
                <!-- 新增：替代讀音輸入 -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">替代讀音 (同音字)</label>
                    <input type="text" id="edit-sound-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-xl text-center" placeholder="若無變調請留空">
                    <p class="text-xs text-slate-400 mt-1">設定此字在朗讀時的發音 (例如：一 -> 移)</p>
                </div>
            </div>
            <div class="mt-6 flex gap-3"><button onclick="window.closeEditModal()" class="flex-1 py-2.5 bg-white border border-slate-300 text-slate-600 rounded-xl font-medium hover:bg-slate-50 transition-colors">取消</button><button onclick="window.confirmEdit()" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">確認修改</button></div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity" onclick="if(event.target === this) window.toggleSettingsModal()">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="sliders" class="w-5 h-5 text-slate-500"></i> 系統設定</h3><button onclick="window.toggleSettingsModal()" class="text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="space-y-6">
                <div><div class="flex justify-between items-center mb-2"><label class="block text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="mic" class="w-4 h-4 text-indigo-500"></i> 朗讀聲音</label><button onclick="window.testVoice()" class="text-xs bg-indigo-100 text-indigo-600 hover:bg-indigo-200 px-3 py-1 rounded-full font-medium transition-colors flex items-center gap-1"><i data-lucide="volume-2" class="w-3 h-3"></i> 試聽</button></div><div class="relative"><select id="voice-select" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 rounded-xl pl-4 pr-10 py-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"><option value="">載入中...</option></select><i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i></div></div>
                <div><div class="flex justify-between mb-2"><label class="block text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="gauge" class="w-4 h-4 text-orange-500"></i> 朗讀語速</label><span id="rate-value" class="text-sm font-mono bg-orange-50 text-orange-600 px-2 py-0.5 rounded-md font-bold">0.8</span></div><div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-xs text-slate-400">慢</span><input type="range" id="rate-range" min="0.2" max="3" step="0.1" value="0.8" class="flex-1 accent-indigo-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"><span class="text-xs text-slate-400">快</span></div></div>
                <div><div class="flex justify-between mb-2"><label class="block text-sm font-bold text-slate-700 flex items-center gap-2"><i data-lucide="type" class="w-4 h-4 text-blue-500"></i> 文字大小</label></div><div class="flex items-center justify-between gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100"><button onclick="window.changeFontSize(-4)" class="p-3 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-indigo-600 hover:border-indigo-300 shadow-sm active:scale-95 transition-all w-12 flex justify-center"><i data-lucide="minus" class="w-5 h-5"></i></button><div class="flex-1 text-center font-mono font-bold text-xl text-slate-700" id="font-display-val">32</div><button onclick="window.changeFontSize(4)" class="p-3 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-indigo-600 hover:border-indigo-300 shadow-sm active:scale-95 transition-all w-12 flex justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button></div></div>
                <div class="h-px bg-slate-100"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2"><i data-lucide="spell-check" class="w-4 h-4 text-emerald-500"></i> 破音字校正</label><div class="flex flex-col gap-2"><div class="flex gap-2"><input type="text" id="poly-char" placeholder="破音字 (例: 樂)" class="w-1/3 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none text-center"><input type="text" id="poly-zhuyin" placeholder="顯示注音 (例: ㄩㄝˋ)" class="w-2/3 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none text-center"></div><div class="flex gap-2"><input type="text" id="poly-sound" placeholder="替代讀音 (同音字, 例: 月)" class="flex-1 p-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none text-center"><button onclick="window.addPolyphone()" class="w-20 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium transition-colors">新增</button></div></div><div id="poly-list" class="mt-2 flex flex-wrap gap-2 text-xs min-h-[30px]"></div><p class="text-xs text-slate-400 mt-1">設定後，朗讀時會使用「替代讀音」的發音，顯示時使用「顯示注音」。</p></div>
            </div>
            <div class="mt-8"><button onclick="window.toggleSettingsModal()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 transition-transform active:scale-95">完成設定</button></div>
        </div>
    </div>

    <div id="import-panel" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl w-full max-w-5xl p-6 shadow-2xl flex flex-col h-[85vh]">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="file-edit" class="w-5 h-5 text-indigo-600"></i>編輯教材內容</h2><button onclick="window.toggleImportPanel()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="mb-4 space-y-3">
                <div class="flex gap-2">
                    <label class="flex-1"><span class="sr-only">上傳檔案</span><div class="relative flex items-center gap-2 px-4 py-2 border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 hover:border-indigo-300 transition-colors group"><i data-lucide="file-up" class="w-5 h-5 text-slate-400 group-hover:text-indigo-500"></i><span class="text-sm text-slate-600 group-hover:text-slate-800">選擇檔案 (TXT/PDF/Word/圖片)</span><input type="file" id="file-upload" accept=".pdf, .txt, .docx, image/png, image/jpeg, image/jpg" class="hidden" onchange="window.handleFileUpload(this)"><div id="file-loading" class="hidden ml-auto flex items-center gap-2"><span id="loading-text" class="text-xs text-indigo-600 font-medium">處理中...</span><div class="loader"></div></div></div></label>
                    <button onclick="window.autoGenerateZhuyin()" class="px-4 py-2 text-sm bg-purple-50 text-purple-600 hover:bg-purple-100 hover:text-purple-700 rounded-lg border border-purple-200 transition-colors flex items-center gap-1 font-medium"><i data-lucide="wand-2" class="w-4 h-4"></i> 自動注音</button>
                    <button onclick="window.clearImportArea()" class="px-3 py-2 text-sm text-slate-500 hover:text-red-500 hover:bg-red-50 rounded-lg border border-transparent hover:border-red-200 transition-colors">清空</button>
                </div>
                <p class="text-xs text-slate-500">支援純文字、PDF、Word(.docx) 或 圖片(PNG/JPG) 格式。可直接貼上「截圖」後自動辨識文字。</p>
            </div>
            <textarea id="import-textarea" class="flex-1 w-full p-4 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none text-base leading-relaxed mb-4 font-mono" placeholder="請輸入或貼上課文 (或按 Ctrl+V 貼上圖片)..."></textarea>
            <div class="flex justify-end gap-3"><button onclick="window.saveToLibraryFromEditor()" class="px-5 py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-medium rounded-xl shadow-lg shadow-amber-200 transition-transform active:scale-95 flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i>雲端儲存</button><button onclick="window.toggleImportPanel()" class="px-5 py-2.5 text-slate-600 font-medium hover:bg-slate-100 rounded-xl transition-colors">取消</button><button onclick="window.confirmImport()" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-lg shadow-indigo-200 transition-transform active:scale-95 flex items-center gap-2"><i data-lucide="check" class="w-4 h-4"></i>確認載入</button></div>
        </div>
    </div>
    
    <div id="library-panel" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl p-6 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><div class="flex flex-col"><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="library" class="w-6 h-6 text-amber-500"></i>雲端教材庫</h2><p class="text-sm text-slate-500 mt-1">您的教材會自動跟隨帳號同步</p></div><button onclick="window.toggleLibraryPanel()" class="p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="flex-1 overflow-y-auto min-h-[300px] p-2"><div id="library-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div><div id="library-empty-state" class="hidden flex flex-col items-center justify-center py-16 text-slate-400"><div class="bg-slate-50 p-6 rounded-full mb-4"><i data-lucide="folder-open" class="w-12 h-12 opacity-30"></i></div><p class="text-lg font-medium text-slate-500">目前沒有儲存的教材</p></div><div id="library-loading" class="flex flex-col items-center justify-center py-16 text-indigo-500"><div class="loader mb-4 w-8 h-8 border-4 border-t-indigo-500"></div><p>正在同步雲端資料...</p></div></div>
        </div>
    </div>
    <div id="legend-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[120] flex items-center justify-center p-4" onclick="if(event.target === this) window.toggleLegend()">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-xl relative animate-in fade-in zoom-in duration-200">
            <button onclick="window.toggleLegend()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 pb-3 border-b border-slate-100"><i data-lucide="info" class="w-5 h-5 text-indigo-500"></i> 檢核報告標示說明</h3>
            <div class="space-y-5"><div class="flex items-start gap-4"><div class="mt-0.5 shrink-0"><span class="text-green-700 font-bold bg-green-50 px-3 py-1.5 rounded-lg border border-green-100 text-sm">文字</span></div><div><p class="font-bold text-slate-700 text-sm mb-0.5">正確</p></div></div><div class="flex items-start gap-4"><div class="mt-0.5 shrink-0"><span class="bg-red-100 text-red-600 line-through decoration-red-400 decoration-2 px-3 py-1.5 rounded-lg border border-red-200 text-sm">文字</span></div><div><p class="font-bold text-slate-700 text-sm mb-0.5">錯誤 / 漏讀</p></div></div><div class="flex items-start gap-4"><div class="mt-0.5 shrink-0"><span class="bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded-lg border border-yellow-200 text-sm">文字</span></div><div><p class="font-bold text-slate-700 text-sm mb-0.5">多讀</p></div></div></div>
            <div class="mt-8"><button onclick="window.toggleLegend()" class="w-full py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-sm font-medium transition-colors">我瞭解了</button></div>
        </div>
    </div>
    <div id="custom-dialog" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100"><h3 id="dialog-title" class="text-lg font-bold text-slate-800 mb-2">標題</h3><p id="dialog-message" class="text-slate-600 mb-4 leading-relaxed">訊息內容</p><input type="text" id="dialog-input" class="hidden w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="請輸入..."><div class="flex justify-end gap-2" id="dialog-buttons"></div></div></div>
    <div id="toast-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 flex flex-col gap-2 z-[110] w-max max-w-[90vw] pointer-events-none"></div>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden max-w-7xl mx-auto w-full p-4 gap-4">
        <div id="left-panel" class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative transition-all duration-300 w-full">
            <div class="flex border-b border-slate-100">
                <button onclick="window.setMode('sentence')" class="mode-tab flex-1 py-3 text-sm font-medium transition-colors border-b-2" data-mode="sentence">逐句練習</button>
                <button onclick="window.setMode('paragraph')" class="mode-tab flex-1 py-3 text-sm font-medium transition-colors border-b-2" data-mode="paragraph">段落朗讀</button>
                <button onclick="window.setMode('article')" class="mode-tab flex-1 py-3 text-sm font-medium transition-colors border-b-2" data-mode="article">全文挑戰</button>
            </div>
            <div id="content-container" class="flex-1 p-8 overflow-y-auto leading-relaxed relative bg-white">
                <div id="text-wrapper" class="relative z-10"></div>
            </div>
            <div id="reading-footer" class="p-4 border-t border-slate-100 flex justify-between items-center bg-slate-50 z-10">
                <div id="nav-group" class="flex items-center gap-3 transition-opacity duration-300"><button onclick="window.prevItem()" class="p-2 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 shadow-sm transition-all text-slate-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><span id="progress-indicator" class="text-sm font-medium text-slate-500 min-w-[3rem] text-center">1 / 10</span><button onclick="window.nextItem()" class="p-2 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 shadow-sm transition-all text-slate-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                <div class="flex gap-3"><button id="autoplay-btn" onclick="window.toggleAutoPlay()" class="bg-white border border-slate-300 text-slate-500 hover:text-indigo-600 hover:border-indigo-300 px-4 py-2 rounded-lg shadow-sm transition-all active:scale-95 flex items-center gap-2"><i data-lucide="repeat" class="w-5 h-5"></i><span class="text-sm font-medium hidden sm:inline">連播</span></button><button id="speak-btn" onclick="window.toggleSpeak()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg shadow-lg transition-transform active:scale-95 flex items-center gap-2"><i data-lucide="volume-2" class="w-5 h-5"></i><span class="font-medium">範讀</span></button></div>
            </div>
        </div>
        <div id="right-panel" class="hidden flex-col gap-4 flex-1 transition-all duration-300">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-1 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><h2 class="font-semibold text-slate-700 flex items-center gap-2"><i data-lucide="mic" class="w-4 h-4 text-indigo-500"></i>學生朗讀區</h2><div class="flex items-center gap-3"><div id="timer" class="text-indigo-600 font-mono font-bold">00:00</div><button onclick="window.togglePracticeMode()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button></div></div>
                <div class="flex-1 p-4 relative"><textarea id="student-input" class="w-full h-full resize-none border-0 focus:ring-0 text-lg p-2 text-slate-700 leading-relaxed placeholder:text-slate-300 overflow-y-auto" placeholder="按下麥克風開始錄音，或直接在此輸入/修正文字..."></textarea><div id="recording-overlay" class="hidden absolute inset-0 bg-white/95 backdrop-blur-md z-10 flex flex-col items-center justify-center gap-6 p-8"><div class="relative"><span class="absolute inset-0 rounded-full bg-red-400 animate-ping opacity-75"></span><div class="relative bg-red-500 text-white p-5 rounded-full shadow-2xl"><i data-lucide="mic" class="w-8 h-8 animate-pulse"></i></div></div><div class="text-center space-y-2"><p class="text-slate-700 font-bold text-xl">正在聆聽中...</p><p class="text-sm text-slate-500">已啟用長文無限續錄模式</p></div><div class="w-full max-w-lg bg-slate-50 rounded-xl border border-slate-200 p-4 min-h-[80px] max-h-[200px] overflow-y-auto shadow-inner text-center"><p id="live-transcript" class="text-lg text-slate-600 font-medium leading-relaxed italic placeholder-text">...</p></div></div></div>
                <div class="p-4 border-t border-slate-100 bg-slate-50 flex gap-3"><button id="record-btn" onclick="window.toggleRecord()" class="flex-1 py-3 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 hover:border-indigo-300 hover:text-indigo-600 rounded-xl font-medium shadow-sm transition-all flex items-center justify-center gap-2"><i data-lucide="mic" class="w-5 h-5"></i><span>開始錄音</span></button><button id="check-btn" onclick="window.analyzeResult()" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-medium shadow-sm shadow-emerald-200 transition-all flex items-center justify-center gap-2"><i data-lucide="clipboard-check" class="w-5 h-5"></i><span>送出檢核</span></button></div>
            </div>
            <div id="analysis-panel" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hidden">
                <div class="flex flex-col gap-4 mb-4"><div class="flex flex-wrap items-center justify-between gap-3"><div class="flex items-center gap-2"><h3 class="font-bold text-slate-800 text-lg">檢核報告</h3><button onclick="window.toggleLegend()" class="text-slate-400 hover:text-indigo-600 transition-colors p-1" title="查看標示說明"><i data-lucide="help-circle" class="w-4 h-4"></i></button></div><div class="flex items-center gap-2"><button onclick="window.downloadPdf()" class="flex items-center gap-1 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium border border-slate-300 transition-colors"><i data-lucide="file-down" class="w-4 h-4"></i><span class="hidden sm:inline">PDF</span></button><button onclick="window.downloadTxtReport()" class="flex items-center gap-1 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium border border-slate-300 transition-colors"><i data-lucide="file-text" class="w-4 h-4"></i><span class="hidden sm:inline">TXT</span></button></div></div><div class="flex flex-wrap items-center justify-between gap-3 text-sm bg-slate-50 p-3 rounded-xl border border-slate-100"><div id="session-stats" class="text-slate-500 hidden flex items-center flex-wrap gap-2"><span>已練習: <span id="session-count" class="font-bold text-indigo-600">0</span> 句</span><span class="hidden sm:inline text-slate-300">|</span><span>平均: <span id="session-avg" class="font-bold text-emerald-600">--%</span></span></div><div id="session-placeholder" class="text-slate-400 italic text-xs hidden">尚無數據</div><div class="flex items-center gap-2 ml-auto"><span class="text-xs text-slate-400 mr-1 hidden sm:inline">圖例:</span><span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium border border-green-200">正確</span><span class="px-2 py-0.5 bg-red-100 text-red-600 line-through decoration-red-400 decoration-2 rounded text-xs font-medium border border-red-200">錯誤</span></div></div></div>
                <div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-indigo-50 p-4 rounded-xl text-center border border-indigo-100"><div class="text-xs text-indigo-400 uppercase font-bold tracking-wider mb-1">正確率</div><div class="text-3xl font-bold text-indigo-700" id="accuracy-score">--%</div></div><div class="bg-orange-50 p-4 rounded-xl text-center border border-orange-100"><div class="text-xs text-orange-400 uppercase font-bold tracking-wider mb-1">語速</div><div class="text-3xl font-bold text-orange-700" id="speed-score">--</div></div></div>
                <div id="diff-output" class="text-lg leading-relaxed p-6 bg-slate-50 rounded-xl border border-slate-200 min-h-[150px] max-h-[400px] overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <footer class="p-2 text-center text-xs text-slate-400 bg-slate-50 border-t border-slate-200 shrink-0">由 <a href="https://www.facebook.com/se365" target="_blank" class="hover:text-indigo-500 transition-colors">特工365</a> 製作</footer>
    <div id="full-report-container" class="hidden bg-white p-8"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = null;
        let libraryUnsubscribe = null;
        const synth = window.speechSynthesis;
        let recognition = null;
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const defaultContent = "春(ㄔㄨㄣ)天(ㄊㄧㄢ)來(ㄌㄞˊ)了(ㄌㄜ˙)，大(ㄉㄚˋ)地(ㄉㄧˋ)醒(ㄒㄧㄥˇ)了(ㄌㄜ˙)。小(ㄒㄧㄠˇ)草(ㄘㄠˇ)從(ㄘㄨㄥˊ)泥(ㄋㄧˊ)土(ㄊㄨˇ)裡(ㄌㄧˇ)鑽(ㄗㄨㄢ)出(ㄔㄨ)來(ㄌㄞˊ)，伸(ㄕㄣ)了(ㄌㄜ˙)伸(ㄕㄣ)懶(ㄌㄢˇ)腰(ㄧㄠ)。花(ㄏㄨㄚ)兒(ㄦˊ)在(ㄗㄞˋ)風(ㄈㄥ)中(ㄓㄨㄥ)點(ㄉㄧㄢˇ)頭(ㄊㄡˊ)，像(ㄒㄧㄤˋ)是(ㄕˋ)在(ㄗㄞˋ)說(ㄕㄨㄛ)悄(ㄑㄧㄠˇ)悄(ㄑㄧㄠˇ)話(ㄏㄨㄚˋ)。樹(ㄕㄨˋ)上(ㄕㄤˋ)的(˙ㄉㄜ)小(ㄒㄧㄠˇ)鳥(ㄋㄧㄠˇ)唱(ㄔㄤˋ)起(ㄑㄧˇ)了(ㄌㄜ˙)歌(ㄍㄜ)，吱(ㄓ)吱(ㄓ)喳(ㄓㄚ)喳(ㄓㄚ)，好(ㄏㄠˇ)熱(ㄖㄜˋ)鬧(ㄋㄠˋ)啊(˙ㄚ)！小(ㄒㄧㄠˇ)河(ㄏㄜˊ)也(ㄧㄝˇ)解(ㄐㄧㄝˇ)凍(ㄉㄨㄥˋ)了(ㄌㄜ˙)，嘩(ㄏㄨㄚˊ)啦(ㄌㄚ)啦(ㄌㄚ)地(ㄉㄧˋ)流(ㄌㄧㄡˊ)著(ㄓㄜ˙)，彷(ㄈㄤˇ)彿(ㄈㄨˊ)在(ㄗㄞˋ)為(ㄨㄟˊ)春(ㄔㄨㄣ)天(ㄊㄧㄢ)伴(ㄅㄢˋ)奏(ㄗㄡˋ)。\n我(ㄨㄛˇ)們(ㄇㄣˊ)脫(ㄊㄨㄛ)下(ㄒㄧㄚˋ)厚(ㄏㄡˋ)厚(ㄏㄡˋ)的(˙ㄉㄜ)棉(ㄇㄧㄢˊ)襖(ㄠˇ)，換(ㄏㄨㄢˋ)上(ㄕㄤˋ)輕(ㄑㄧㄥ)便(ㄅㄧㄢˋ)的(˙ㄉㄜ)春(ㄔㄨㄣ)裝(ㄓㄨㄤ)，跑(ㄆㄠˇ)到(ㄉㄠˋ)田(ㄊㄧㄢˊ)野(ㄧㄝˇ)裡(ㄌㄧˇ)去(ㄑㄩˋ)放(ㄈㄤˋ)風(ㄈㄥ)箏(ㄓㄥ)。春(ㄔㄨㄣ)天(ㄊㄧㄢ)的(˙ㄉㄜ)聲(ㄕㄥ)音(ㄧㄣ)，是(ㄕˋ)快(ㄎㄨㄞˋ)樂(ㄌㄜˋ)的(˙ㄉㄜ)聲(ㄕㄥ)音(ㄧㄣ)，是(ㄕˋ)希(ㄒㄧ)望(ㄨㄤˋ)的(˙ㄉㄜ)聲(ㄕㄥ)音(ㄧㄣ)。";

        const state = {
            mode: 'sentence', currentIndex: 0, segments: [], results: [], fontSize: 32, voiceRate: 0.8, selectedVoice: null,
            clickMode: 'sentence', isRecording: false, recordingTime: 0, timerInterval: null, fullText: defaultContent, isPracticeOpen: false,
            lastRenderedMode: null, drawings: {}, 
            polyphones: { 
                '地': { zhuyin: 'ㄉㄧˋ', sound: '第' },
                '悄': { zhuyin: 'ㄑㄧㄠˇ', sound: '巧' },
                '喳': { zhuyin: 'ㄓㄚ', sound: '渣' }
            },
            isEditMode: false, editingTarget: null,
            showZhuyin: true, isAutoPlay: false
        };

        const drawingState = { isDrawing: false, tool: 'pen', color: '#ef4444', lineWidth: 2, lastX: 0, lastY: 0, active: false, activeCanvas: null, currentPath: null, history: [], redoStack: [] };

        async function processImageWithOCR(imageFile) {
            if (typeof Tesseract === 'undefined') {
                window.showToast("OCR 套件載入失敗，請檢查網路連線", "error");
                return;
            }
            const worker = Tesseract.createWorker({
                logger: m => {
                    console.log(m);
                    if(m.status === 'recognizing text') {
                        document.getElementById('loading-text').textContent = `辨識中... ${Math.round(m.progress * 100)}%`;
                    }
                }
            });
            try {
                await worker.load();
                await worker.loadLanguage('chi_tra');
                await worker.initialize('chi_tra');
                const { data: { text } } = await worker.recognize(imageFile);
                await worker.terminate();
                let cleanedText = text.replace(/([^\x00-\xff])\s+([^\x00-\xff])/g, '$1$2');
                const textarea = document.getElementById('import-textarea');
                textarea.value += (textarea.value ? '\n' : '') + cleanedText;
                window.showToast("圖片文字辨識完成", "success");
            } catch (err) {
                console.error("OCR Error:", err);
                window.showToast("圖片辨識失敗，請重試", "error");
            }
        }
        
        async function processWordFile(file) {
            const loadingEl = document.getElementById('file-loading');
            const loadingText = document.getElementById('loading-text');
            loadingEl.classList.remove('hidden');
            loadingText.textContent = "讀取 Word 檔...";
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                const text = result.value;
                const textarea = document.getElementById('import-textarea');
                textarea.value = text.trim();
                window.showToast("Word 檔讀取成功", "success");
            } catch (err) {
                console.error("Word processing error:", err);
                window.showToast("Word 檔讀取失敗: " + err.message, "error");
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        window.updateTimerDisplay = () => { 
            const m = Math.floor(state.recordingTime / 60).toString().padStart(2,'0'); 
            const s = (state.recordingTime % 60).toString().padStart(2,'0'); 
            document.getElementById('timer').textContent = `${m}:${s}`; 
        }

        window.startTimer = () => { state.timerInterval = setInterval(() => { state.recordingTime++; window.updateTimerDisplay(); }, 1000); };
        window.stopTimer = () => clearInterval(state.timerInterval);
        window.resetTimer = () => { window.stopTimer(); state.recordingTime = 0; window.updateTimerDisplay(); };

        window.toggleRecord = () => {
            if (state.isRecording) {
                state.isRecording = false;
                window.stopTimer();
                updateRecordingUI(false);
                try { recognition.stop(); } catch(e) { console.log('Stop error:', e); }
            } else {
                try {
                    recognition.start();
                    state.isRecording = true;
                    window.startTimer();
                    updateRecordingUI(true);
                } catch(e) {
                    if (e.name === 'InvalidStateError') {
                        console.log('Recognition already started');
                        state.isRecording = true;
                        window.startTimer();
                        updateRecordingUI(true);
                    } else {
                        console.error(e);
                        window.showToast("無法啟動麥克風: " + e.message, "error");
                        state.isRecording = false;
                        updateRecordingUI(false);
                    }
                }
            }
        };

        window.updateRecordingUI = (isRecording) => { 
            const btn = document.getElementById('record-btn'); 
            const overlay = document.getElementById('recording-overlay'); 
            const textarea = document.getElementById('student-input'); 
            const checkBtn = document.getElementById('check-btn'); 
            if (isRecording) { 
                btn.innerHTML = '<i data-lucide="pause" class="w-5 h-5 fill-current"></i><span>暫停/編輯</span>'; 
                btn.className = "flex-1 py-3 bg-red-50 border border-red-200 text-red-600 hover:bg-red-100 rounded-xl font-medium shadow-sm transition-all flex items-center justify-center gap-2"; 
                overlay.classList.remove('hidden'); 
                document.getElementById('analysis-panel').classList.add('hidden'); 
                checkBtn.disabled = true; 
            } else { 
                btn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i><span>開始錄音</span>'; 
                btn.className = "flex-1 py-3 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 hover:border-indigo-300 hover:text-indigo-600 rounded-xl font-medium shadow-sm transition-all flex items-center justify-center gap-2"; 
                overlay.classList.add('hidden'); 
                textarea.focus(); 
                checkBtn.disabled = false; 
            } 
            lucide.createIcons(); 
        }

        window.updateSessionStats = () => {
            const done = state.results.filter(r => r); 
            const statsEl = document.getElementById('session-stats'); 
            const placeholderEl = document.getElementById('session-placeholder');
            if (done.length) { 
                const avg = Math.round(done.reduce((a,c) => a + c.accuracy, 0) / done.length); 
                const countEl = document.getElementById('session-count');
                const avgEl = document.getElementById('session-avg');
                if (countEl) countEl.textContent = done.length; 
                if (avgEl) avgEl.textContent = `${avg}%`; 
                if (statsEl) statsEl.classList.remove('hidden'); 
                if (placeholderEl) placeholderEl.classList.add('hidden'); 
            } else { 
                if (statsEl) statsEl.classList.add('hidden'); 
                if (placeholderEl) placeholderEl.classList.remove('hidden'); 
            }
        }

        window.updateHistoryUI = () => {
            const undoBtn = document.getElementById('tool-undo');
            const redoBtn = document.getElementById('tool-redo');
            if (undoBtn) undoBtn.disabled = drawingState.history.length === 0;
            if (redoBtn) redoBtn.disabled = drawingState.redoStack.length === 0;
            if(undoBtn) {
                 undoBtn.className = `p-2 rounded-md transition-all ${drawingState.history.length > 0 ? 'text-indigo-600 hover:bg-indigo-50' : 'text-slate-300 cursor-not-allowed'}`;
            }
            if(redoBtn) {
                 redoBtn.className = `p-2 rounded-md transition-all ${drawingState.redoStack.length > 0 ? 'text-indigo-600 hover:bg-indigo-50' : 'text-slate-300 cursor-not-allowed'}`;
            }
        }
        
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function loadVoices() {
            const select = document.getElementById('voice-select'); if(!select) return; 
            const currentSelection = select.value || state.selectedVoice;
            const voices = synth.getVoices(); select.innerHTML = '';
            const zhVoices = voices.filter(v => v.lang.includes('zh') || v.lang.includes('TW') || v.lang.includes('CN'));
            (zhVoices.length ? zhVoices : voices).forEach(v => { const opt = document.createElement('option'); opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`; select.appendChild(opt); });
            if(currentSelection) select.value = currentSelection;
        }

        function convertPinyinToZhuyin(pinyin) {
            let tone = pinyin.match(/[\d]+$/) ? pinyin.match(/[\d]+$/)[0] : '5';
            let base = pinyin.replace(/[\d]+$/, '');
            let zhuyinTone = pinyinToZhuyinMap.tones[tone] || '';
            
            // 修正特殊拼音對應
            if (base === 'ju') base = 'jv'; 
            if (base === 'qu') base = 'qv'; 
            if (base === 'xu') base = 'xv';
            if (base === 'yu') base = 'v'; 
            if (base === 'yi') base = 'i'; 
            if (base === 'wu') base = 'u';
            if (base === 'yv') base = 'v'; 
            
            // 處理 y, w 開頭的組合韻
            if (base === 'yan') base = 'ian';
            if (base === 'wan') base = 'uan';
            if (base === 'yue') base = 've';
            if (base === 'yuan') base = 'van';
            if (base === 'yun') base = 'vn';
            if (base === 'yong') base = 'iong';
            if (base === 'ying') base = 'ing';
            if (base === 'weng') base = 'ueng'; // 實際上 weng -> ueng -> ㄨㄥ

            // 處理 zi, ci, si, zhi, chi, shi, ri 的空韻
            if (['zi', 'ci', 'si', 'zhi', 'chi', 'shi', 'ri'].includes(base)) { 
                base = base.replace('i',''); 
            } 
            
            let initial = '';
            let final = '';
            
            // 嘗試匹配聲母
            for (let init of Object.keys(pinyinToZhuyinMap.bpmf).sort((a,b)=>b.length-a.length)) {
                if (base.startsWith(init)) {
                    initial = pinyinToZhuyinMap.bpmf[init];
                    base = base.substring(init.length);
                    break;
                }
            }
            
            // 匹配韻母
            if (base.length > 0) {
                if (pinyinToZhuyinMap.finals[base]) {
                    final = pinyinToZhuyinMap.finals[base];
                } else {
                    // 特殊處理
                    if (base === 'iong') final = 'ㄩㄥ';
                    else if (base === 'ui') final = 'ㄨㄟ';
                    else if (base === 'iu') final = 'ㄧㄡ';
                    else if (base === 'ong' && !initial) final = 'ㄨㄥ'; // ong 獨用時
                    else final = base; 
                }
            }
            
            let zhuyin = initial + final;
            
            // 修正：如果沒有聲母也沒有韻母，可能是轉換失敗，回傳原值
            if (!zhuyin && !zhuyinTone) return pinyin;

            if (zhuyinTone === '˙') return '˙' + zhuyin;
            return zhuyin + zhuyinTone;
        }
        
        const pinyinToZhuyinMap = {
            'bpmf': {'b':'ㄅ','p':'ㄆ','m':'ㄇ','f':'ㄈ','d':'ㄉ','t':'ㄊ','n':'ㄋ','l':'ㄌ','g':'ㄍ','k':'ㄎ','h':'ㄏ','j':'ㄐ','q':'ㄑ','x':'ㄒ','zh':'ㄓ','ch':'ㄔ','sh':'ㄕ','r':'ㄖ','z':'ㄗ','c':'ㄘ','s':'ㄙ','y':'ㄧ','w':'ㄨ'},
            'finals': {'a':'ㄚ','o':'ㄛ','e':'ㄜ','ai':'ㄞ','ei':'ㄟ','ao':'ㄠ','ou':'ㄡ','an':'ㄢ','en':'ㄣ','ang':'ㄤ','eng':'ㄥ','er':'ㄦ','i':'ㄧ','u':'ㄨ','v':'ㄩ','ü':'ㄩ','ia':'ㄧㄚ','ie':'ㄧㄝ','iao':'ㄧㄠ','iu':'ㄧㄡ','ian':'ㄧㄢ','in':'ㄧㄣ','iang':'ㄧㄤ','ing':'ㄧㄥ','ua':'ㄨㄚ','uo':'ㄨㄛ','uai':'ㄨㄞ','ui':'ㄨㄟ','uan':'ㄨㄢ','un':'ㄨㄣ','uang':'ㄨㄤ','ong':'ㄨㄥ','ue':'ㄩㄝ','ve':'ㄩㄝ','van':'ㄩㄢ','un':'ㄩㄣ','vn':'ㄩㄣ','iong':'ㄩㄥ','ueng':'ㄨㄥ'},
            'tones': {'1':'','2':'ˊ','3':'ˇ','4':'ˋ','5':'˙','0':'˙'}
        };

        window.autoGenerateZhuyin = () => {
             const text = document.getElementById('import-textarea').value.trim();
             if(!text) { window.showToast("請輸入文字", "error"); return; }
             try {
                if(typeof pinyinPro !== 'undefined') {
                    const { pinyin } = pinyinPro;
                    const result = [];
                    for (let char of text) {
                        if (/[\u4e00-\u9fa5]/.test(char)) {
                            // 使用 array 模式獲取拼音
                            const py = pinyin(char, { toneType: 'num', type: 'array' })[0];
                            const zy = convertPinyinToZhuyin(py);
                            result.push(`${char}(${zy})`);
                        } else {
                            result.push(char);
                        }
                    }
                    document.getElementById('import-textarea').value = result.join('');
                    window.showToast("已自動生成注音", "success");
                } else {
                    window.showToast("注音套件載入中，請稍後", "info");
                }
             } catch(e) {
                 console.error(e);
                 window.showToast("自動注音失敗", "error");
             }
        };

        function parseSegmentToChars(text) {
            // Regex handles optional [sound] part: Char(Zhuyin)[Sound]
            const regex = /(.)\((.*?)\)(?:\[(.*?)\])?|(\n)|(.)/g;
            const chars = [];
            let match;
            while ((match = regex.exec(text)) !== null) {
                if (match[1]) { 
                    // Case 1: Char(Zhuyin) or Char(Zhuyin)[Sound]
                    let char = match[1];
                    let zhuyin = match[2];
                    let sound = match[3] || ''; // Captured sound if exists
                    
                    chars.push({ char, zhuyin, sound });
                } else if (match[4]) { 
                    // Case 2: Newline
                    chars.push({ char: '\n', zhuyin: '', sound: '' });
                } else if (match[5]) { 
                    // Case 3: Bare Char
                    let char = match[5];
                    let zhuyin = '';
                    let sound = '';
                    if (state.polyphones[char]) {
                        zhuyin = state.polyphones[char].zhuyin;
                        sound = state.polyphones[char].sound;
                    }
                    const isPunctuation = /[，。！？、：；,.!?;:]/.test(char);
                    chars.push({ char, zhuyin, sound, isPunctuation });
                }
            }
            return chars;
        }

        window.addPolyphone = () => {
            const char = document.getElementById('poly-char').value.trim();
            const zhuyin = document.getElementById('poly-zhuyin').value.trim();
            const sound = document.getElementById('poly-sound').value.trim();
            if (char && zhuyin) {
                state.polyphones[char] = { zhuyin: zhuyin, sound: sound || char };
                document.getElementById('poly-char').value = '';
                document.getElementById('poly-zhuyin').value = '';
                document.getElementById('poly-sound').value = '';
                renderPolyphones();
                renderContent(true);
            }
        };

        window.removePolyphone = (char) => {
            delete state.polyphones[char];
            renderPolyphones();
            renderContent(true);
        };

        function renderPolyphones() {
            const list = document.getElementById('poly-list');
            list.innerHTML = '';
            Object.keys(state.polyphones).forEach(char => {
                const item = document.createElement('span');
                const data = state.polyphones[char];
                const soundText = data.sound && data.sound !== char ? ` (${data.sound})` : '';
                item.className = 'inline-flex items-center gap-1 bg-emerald-50 text-emerald-700 border border-emerald-200 px-2 py-1 rounded-lg shadow-sm';
                item.innerHTML = `${char} <i data-lucide="arrow-right" class="w-3 h-3"></i> ${data.zhuyin}${soundText} <button onclick="window.removePolyphone('${char}')" class="ml-1 text-emerald-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                list.appendChild(item);
            });
            lucide.createIcons();
        }
        
        function applyPolyphones(text) {
             let processed = text;
             Object.keys(state.polyphones).forEach(char => {
                 const regex = new RegExp(char, 'g');
                 processed = processed.replace(regex, state.polyphones[char].sound);
             });
             return processed;
        }

        function reconstructTextFromChars(chars) {
            return chars.map(c => {
                if (c.char === '\n') return '\n';
                if (c.zhuyin || c.sound) {
                    let res = `${c.char}(${c.zhuyin || ''})`;
                    if (c.sound) res += `[${c.sound}]`;
                    return res;
                }
                return c.char;
            }).join('');
        }

        function speakTextData(text, offset, mode) {
            if (state.isEditMode) return; 

            synth.cancel();
            
            let textToSpeak = "";
            let speechOffsetMap = []; 
            
            if (text !== null) {
                const segment = state.segments[state.currentIndex];
                const chars = parseSegmentToChars(segment); 
                
                let targetChars = [];
                if (mode === 'full') {
                     targetChars = chars.slice(offset);
                } else if (text) {
                     const length = text.length; 
                     targetChars = chars.slice(offset, offset + length);
                } else {
                     targetChars = chars.slice(offset);
                }

                textToSpeak = targetChars.map(c => {
                    if (c.char === '\n') return ' ';
                    if (c.sound) return c.sound;
                    if (state.polyphones[c.char]) return state.polyphones[c.char].sound;
                    return c.char;
                }).join('');
            } else {
                const chars = parseSegmentToChars(state.segments[state.currentIndex]);
                textToSpeak = chars.slice(offset).map(c => {
                    if (c.char === '\n') return ' ';
                    if (c.sound) return c.sound;
                    if (state.polyphones[c.char]) return state.polyphones[c.char].sound;
                    return c.char;
                }).join('');
            }
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            const voiceName = document.getElementById('voice-select').value;
            const voices = synth.getVoices();
            utterance.voice = voices.find(v => v.name === voiceName) || voices[0];
            utterance.rate = parseFloat(document.getElementById('rate-range').value);
            state.speechOffset = offset;
            
            document.querySelectorAll('.reading-active, .reading-past').forEach(el => el.classList.remove('reading-active', 'reading-past'));

            utterance.onstart = () => { state.isSpeaking = true; if(mode === 'full') updateSpeakUI(true); };
            
            utterance.onend = () => {
                state.isSpeaking = false; 
                document.querySelectorAll('.reading-active').forEach(el => el.classList.remove('reading-active'));
                
                if (mode === 'full' && (state.isAutoPlay || state.mode === 'article') && state.currentIndex < state.segments.length - 1 && !state.isJumping) {
                    setTimeout(() => { 
                        state.currentIndex++;
                        renderContent(false); 
                        speakTextData(null, 0, 'full');
                    }, 500);
                } else {
                    updateSpeakUI(false);
                }
            };
            
            utterance.onboundary = (e) => {
                if (e.name === 'word') {
                    document.querySelectorAll('.reading-active').forEach(el => {
                        el.classList.remove('reading-active');
                        el.classList.add('reading-past');
                    });

                    const boxes = document.querySelectorAll(`#segment-${state.currentIndex} .char-box`);
                    const targetIndex = e.charIndex + state.speechOffset;
                    
                    for(let i=0; i<(e.charLength||1); i++) {
                       if (boxes[targetIndex + i]) {
                           boxes[targetIndex + i].classList.add('reading-active');
                           boxes[targetIndex + i].classList.remove('reading-past');
                       }
                    }
                }
            };
            synth.speak(utterance);
        }

        window.testVoice = () => {
            synth.cancel();
            let text = "這是新的朗讀語音。";
            const utterance = new SpeechSynthesisUtterance(text);
            const voiceName = document.getElementById('voice-select').value;
            const voices = synth.getVoices();
            utterance.voice = voices.find(v => v.name === voiceName) || voices[0];
            utterance.rate = parseFloat(document.getElementById('rate-range').value);
            synth.speak(utterance);
        };

        function updateSpeakUI(active) {
            const btn = document.getElementById('speak-btn');
            if (active) { btn.innerHTML = '<i data-lucide="square" class="w-6 h-6 fill-current"></i><span class="font-medium pr-1">停止</span>'; btn.className = "bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg shadow-lg transition-transform active:scale-95 flex items-center gap-2"; }
            else { btn.innerHTML = '<i data-lucide="volume-2" class="w-5 h-5"></i><span class="font-medium">範讀</span>'; btn.className = "bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg shadow-lg transition-transform active:scale-95 flex items-center gap-2"; }
            lucide.createIcons();
        }

        function findUnitBounds(index, mode) {
            const boxes = Array.from(document.querySelectorAll(`#segment-${state.currentIndex} .char-box`));
            if (!boxes[index]) return { start: 0, end: 0, text: '' };

            const getText = (i) => boxes[i].querySelector('.char').textContent;
            
            if (mode === 'word') return { start: index, end: index + 1, text: getText(index) };
            
            const regex = mode === 'sentence' ? /[。！？!?\n]/ : /[。！？!?\n，,、；;：:]/;
            
            let start = index; 
            while (start > 0 && !regex.test(getText(start - 1))) start--;
            
            let end = index; 
            while (end < boxes.length) { 
                if (regex.test(getText(end))) { end++; break; } 
                end++; 
            }
            
            let text = "";
            for(let i=start; i<end; i++) text += getText(i);
            
            return { start, end, text };
        }

        function renderContent(forceRebuild = false) {
            const container = document.getElementById('content-container');
            const wrapper = document.getElementById('text-wrapper'); 
            
            if (forceRebuild || state.lastRenderedMode !== state.mode) {
                state.lastRenderedMode = state.mode;
                wrapper.innerHTML = '';
                container.style.fontSize = `${state.fontSize}px`;

                if (state.isEditMode) wrapper.classList.add('edit-mode-active');
                else wrapper.classList.remove('edit-mode-active');
                
                if (!state.showZhuyin) wrapper.classList.add('hide-zhuyin');
                else wrapper.classList.remove('hide-zhuyin');

                state.segments.forEach((segText, segIdx) => {
                    const segmentDiv = document.createElement('div');
                    segmentDiv.className = 'segment-wrapper'; 
                    segmentDiv.id = `segment-${segIdx}`;
                    
                    if (state.mode === 'article' || state.mode === 'paragraph') {
                        segmentDiv.style.textAlign = 'justify';
                        segmentDiv.style.textIndent = '2em'; 
                        segmentDiv.style.display = 'block'; 
                    } else {
                        segmentDiv.style.textAlign = 'left';
                        segmentDiv.style.textIndent = '0';
                    }
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'segment-canvas';
                    canvas.id = `canvas-${segIdx}`;
                    canvas.dataset.segIdx = segIdx; 
                    segmentDiv.appendChild(canvas);

                    const textDiv = document.createElement('div');
                    textDiv.className = 'relative z-10'; 
                    
                    const parsedChars = parseSegmentToChars(segText);
                    
                    parsedChars.forEach((item, charIdx) => {
                        if (item.char === '\n') {
                            const br = document.createElement('div');
                            br.style.width = "100%";
                            textDiv.appendChild(br);
                            return;
                        }

                        const box = document.createElement('div');
                        box.className = 'char-box';
                        box.id = `seg-${segIdx}-char-${charIdx}`;
                        box.dataset.segIdx = segIdx;
                        box.dataset.charIdx = charIdx;
                        
                        let zhuyinHtml = '';
                        if (item.zhuyin) {
                            let main = item.zhuyin;
                            let tone = '';
                            
                            let isLight = false;
                            if (main.startsWith('˙') || main.endsWith('˙')) {
                                isLight = true;
                                main = main.replace(/˙/g, ''); 
                            }

                            const lastChar = main.slice(-1);
                            if (['ˊ', 'ˇ', 'ˋ'].includes(lastChar)) {
                                tone = lastChar;
                                main = main.slice(0, -1);
                            }

                            let parts = main.split('');
                            
                            if (isLight) parts.unshift('˙');

                            let innerHtml = '';
                            parts.forEach((p, idx) => {
                                let toneHtml = '';
                                
                                if (idx === parts.length - 1 && tone) {
                                    toneHtml = `<span class="z-tone">${tone}</span>`;
                                }
                                
                                let specialClass = '';
                                if (p === '˙') {
                                    specialClass = ' light-dot';
                                }

                                innerHtml += `<span class="z-char${specialClass}">${p}${toneHtml}</span>`;
                            });

                            zhuyinHtml = `<div class="zhuyin">${innerHtml}</div>`;
                        }

                        box.innerHTML = `<span class="char">${item.char}</span>${zhuyinHtml}`;
                        
                        box.onclick = (e) => {
                            e.stopPropagation();
                            if (state.isEditMode) {
                                window.openEditModal(segIdx, charIdx, item);
                            } else {
                                window.jumpTo(segIdx, charIdx);
                            }
                        };
                        
                        textDiv.appendChild(box);
                    });
                    
                    segmentDiv.appendChild(textDiv);
                    wrapper.appendChild(segmentDiv);
                });
                
                initSegmentCanvases();
            }

            document.querySelectorAll('.segment-wrapper').forEach((el, idx) => {
                if (idx === state.currentIndex) {
                    el.style.display = 'block'; 
                    if (!forceRebuild) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    if (state.mode === 'article') { el.style.display = 'block'; } 
                    else { el.style.display = 'none'; }
                }
            });

            const navGroup = document.getElementById('nav-group');
            if (state.segments.length <= 1) {
                 if(state.mode === 'article') navGroup.classList.add('invisible');
                 else navGroup.classList.add('invisible');
            } else {
                navGroup.classList.remove('invisible');
                document.getElementById('progress-indicator').textContent = `${state.currentIndex + 1} / ${state.segments.length}`;
            }

            window.setClickMode(state.clickMode);
            setTimeout(resizeAllCanvases, 50);
        }

        window.toggleZhuyin = () => {
            state.showZhuyin = !state.showZhuyin;
            const btn = document.getElementById('btn-toggle-zhuyin');
            const wrapper = document.getElementById('text-wrapper');
            if (state.showZhuyin) {
                wrapper.classList.remove('hide-zhuyin');
                btn.classList.add('bg-sky-50', 'text-sky-600', 'border-sky-200');
                btn.classList.remove('bg-white', 'text-slate-400', 'border-slate-300');
                btn.innerHTML = '<i data-lucide="eye" class="w-4 h-4"></i>顯示注音';
            } else {
                wrapper.classList.add('hide-zhuyin');
                btn.classList.remove('bg-sky-50', 'text-sky-600', 'border-sky-200');
                btn.classList.add('bg-white', 'text-slate-400', 'border-slate-300');
                btn.innerHTML = '<i data-lucide="eye-off" class="w-4 h-4"></i>隱藏注音';
            }
            lucide.createIcons();
            setTimeout(resizeAllCanvases, 100);
        };

        window.toggleEditMode = () => {
            state.isEditMode = !state.isEditMode;
            const btn = document.getElementById('btn-edit-mode');
            const wrapper = document.getElementById('text-wrapper');
            if (state.isEditMode) {
                btn.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-400');
                btn.classList.remove('bg-white', 'text-slate-600', 'border-slate-300');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>完成編輯';
                wrapper.classList.add('edit-mode-active');
                window.showToast("點擊文字即可修改注音");
                window.stopSpeaking();
            } else {
                btn.classList.remove('bg-blue-100', 'text-blue-700', 'border-blue-400');
                btn.classList.add('bg-white', 'text-slate-600', 'border-slate-300');
                btn.innerHTML = '<i data-lucide="edit-3" class="w-4 h-4"></i>編輯';
                wrapper.classList.remove('edit-mode-active');
            }
            lucide.createIcons();
        };

        window.openEditModal = (segIdx, charIdx, item) => {
            state.editingTarget = { segIdx, charIdx };
            document.getElementById('edit-char-input').value = item.char;
            document.getElementById('edit-zhuyin-input').value = item.zhuyin || '';
            document.getElementById('edit-sound-input').value = item.sound || ''; // Fill sound
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-zhuyin-input').focus();
        };

        window.closeEditModal = () => {
            document.getElementById('edit-modal').classList.add('hidden');
            state.editingTarget = null;
        };

        window.confirmEdit = () => {
            if (!state.editingTarget) return;
            const { segIdx, charIdx } = state.editingTarget;
            const newChar = document.getElementById('edit-char-input').value.trim();
            const newZhuyin = document.getElementById('edit-zhuyin-input').value.trim();
            const newSound = document.getElementById('edit-sound-input').value.trim(); // Get sound
            if (!newChar) { window.showToast("國字不能為空", "error"); return; }
            
            let segText = state.segments[segIdx];
            let chars = parseSegmentToChars(segText);
            if (chars[charIdx]) {
                chars[charIdx].char = newChar;
                chars[charIdx].zhuyin = newZhuyin;
                chars[charIdx].sound = newSound; // Update sound
                const newSegText = reconstructTextFromChars(chars);
                state.segments[segIdx] = newSegText;
                renderContent(true); 
                window.closeEditModal();
                window.showToast("修改成功", "success");
            }
        };

        // Fix: Enhanced downloadNote with Stronger Pagination Logic
        window.downloadNote = async () => {
            // Check if html2pdf is available
            if (typeof html2pdf === 'undefined') {
                window.showToast("PDF元件尚未載入，請稍後再試", "error");
                return;
            }

            window.showToast("正在產生 PDF，請稍候...", "info");

            const container = document.getElementById('content-container');
            const leftPanel = document.getElementById('left-panel');
            const mainEl = document.querySelector('main');
            const segments = document.querySelectorAll('.segment-wrapper');
            
            const originalDisplays = [];
            const scrollPos = window.scrollY;
            const containerScrollPos = container.scrollTop;
            
            // --- 1. 保存原始樣式 ---
            const originalStyles = {
                containerWidth: container.style.width,
                containerHeight: container.style.height,
                containerOverflow: container.style.overflow,
                containerMaxHeight: container.style.maxHeight,
                panelOverflow: leftPanel.style.overflow,
                mainOverflow: mainEl.style.overflow,
                bodyOverflow: document.body.style.overflow,
                bodyHeight: document.body.style.height,
                mainHeight: mainEl.style.height,
                panelHeight: leftPanel.style.height,
            };

            // --- 2. 展開所有父層容器 ---
            // 這是關鍵修正：確保所有父層元素的高度都不受限制，讓 html2canvas 能抓到完整的長度
            document.body.style.height = 'auto';
            document.body.style.overflow = 'visible';
            mainEl.style.height = 'auto';
            mainEl.style.overflow = 'visible';
            leftPanel.style.height = 'auto';
            leftPanel.style.overflow = 'visible';
            
            // --- 3. 鎖定寬度 & 解除高度限制 ---
            const computedWidth = container.getBoundingClientRect().width;
            
            container.style.width = `${computedWidth}px`; 
            container.style.height = 'auto';
            container.style.overflow = 'visible';
            container.style.maxHeight = 'none';
            container.style.position = 'relative'; // 確保定位正確

            // --- 4. 展開所有段落 (適用於任何模式) ---
            segments.forEach(el => { 
                originalDisplays.push(el.style.display); 
                el.style.display = 'block'; 
            });
            
            // --- 5. 強制重繪 & Canvas 調整 ---
            await new Promise(resolve => requestAnimationFrame(resolve));
            resizeAllCanvases();

            // 等待渲染穩定
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // 計算展開後的總高度，用於設定 canvas 大小
            const totalHeight = container.scrollHeight + 100; // 增加一些緩衝

            const opt = {
                margin:       [15, 10, 15, 10], // 上下留白
                filename:     `reading_notes_${new Date().getTime()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    scrollY: 0,
                    scrollX: 0,
                    width: computedWidth,
                    windowWidth: Math.max(computedWidth + 50, document.documentElement.offsetWidth),
                    height: totalHeight,        // 明確設定高度
                    windowHeight: totalHeight,  // 明確設定視窗高度，防止裁切
                    
                    onclone: (clonedDoc) => {
                        // 在此處插入強制樣式，確保打印時絕對不裁切字元
                        const style = clonedDoc.createElement('style');
                        style.innerHTML = `
                            /* 關鍵修正：恢復 inline-flex 以保持注音在文字旁，但增加 padding 防止裁切 */
                            .char-box { 
                                display: inline-flex !important; 
                                flex-direction: row !important;
                                align-items: center !important;
                                page-break-inside: avoid !important; 
                                break-inside: avoid !important;
                                -webkit-column-break-inside: avoid !important;
                                position: relative !important;
                                height: auto !important; 
                                min-height: 3.5em !important; 
                                margin: 5px 2px !important; /* 增加間距 */
                                padding-top: 5px !important; 
                                padding-right: 15px !important; /* 增加右側內距給聲調 */
                                width: auto !important;
                            }
                            /* 確保段落行高足夠 */
                            .segment-wrapper {
                                display: block !important;
                                line-height: 3.5 !important; 
                                page-break-inside: auto !important;
                                margin-bottom: 20px !important;
                            }
                            /* 確保注音容器正常顯示 */
                            .zhuyin {
                                display: flex !important;
                                flex-direction: column !important;
                                position: relative !important;
                                width: 1.2em !important;
                                overflow: visible !important; /* 防止內容被切 */
                            }
                            /* 修正聲調位置，確保不跑版 */
                            .z-tone {
                                position: absolute !important;
                                right: -0.8em !important; 
                                top: -0.2em !important;
                                transform: scale(1.1) !important;
                            }
                            /* 全局設定 */
                            body {
                                height: auto !important;
                                overflow: visible !important;
                            }
                        `;
                        clonedDoc.head.appendChild(style);

                        const originalCanvases = document.querySelectorAll('.segment-canvas');
                        const clonedCanvases = clonedDoc.querySelectorAll('.segment-canvas');
                        
                        originalCanvases.forEach((orig, index) => {
                            if (clonedCanvases[index]) {
                                const destCtx = clonedCanvases[index].getContext('2d');
                                destCtx.drawImage(orig, 0, 0);
                            }
                        });
                        
                        // 確保複製後的 DOM 樣式正確
                        const clonedContainer = clonedDoc.getElementById('content-container');
                        if (clonedContainer) {
                            clonedContainer.style.height = 'auto';
                            clonedContainer.style.overflow = 'visible';
                            clonedContainer.style.maxHeight = 'none';
                            clonedContainer.style.width = `${computedWidth}px`;
                            clonedContainer.style.display = 'block'; 
                        }
                    }
                },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' },
                // 啟用智慧分頁模式，保留 legacy 以確保兼容性
                pagebreak:    { mode: ['css', 'legacy'] } 
            };

            try {
                await html2pdf().set(opt).from(container).save();
                window.showToast("PDF 下載成功", "success");
            } catch (error) {
                console.error("PDF generation failed:", error);
                window.showToast("PDF 下載失敗: " + error.message, "error");
            } finally {
                // --- 6. 復原原始狀態 ---
                segments.forEach((el, idx) => { 
                    el.style.display = originalDisplays[idx]; 
                });
                
                container.style.width = originalStyles.containerWidth;
                container.style.height = originalStyles.containerHeight;
                container.style.overflow = originalStyles.containerOverflow;
                container.style.maxHeight = originalStyles.containerMaxHeight;
                container.style.position = ''; // 清除定位

                leftPanel.style.overflow = originalStyles.panelOverflow;
                leftPanel.style.height = originalStyles.panelHeight;
                
                mainEl.style.overflow = originalStyles.mainOverflow;
                mainEl.style.height = originalStyles.mainHeight;
                
                document.body.style.overflow = originalStyles.bodyOverflow;
                document.body.style.height = originalStyles.bodyHeight;
                
                window.scrollTo(0, scrollPos);
                container.scrollTop = containerScrollPos;
                
                resizeAllCanvases();
            }
        };

        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.stopSpeaking = () => { synth.cancel(); state.isSpeaking = false; updateSpeakUI(false); document.querySelectorAll('.char-box').forEach(s => s.classList.remove('reading-active', 'reading-past')); };
        window.toggleSpeak = () => { if (state.isSpeaking) window.stopSpeaking(); else speakTextData(null, 0, 'full'); };
        
        window.jumpTo = (segIdx, charIdx) => {
            if(state.isRecording || state.isEditMode) return;
            if (segIdx !== undefined && segIdx !== state.currentIndex) { state.currentIndex = segIdx; renderContent(false); }
            if (state.clickMode === 'silent') {
                document.querySelectorAll('.char-box').forEach(s => s.classList.remove('reading-active'));
                const el = document.getElementById(`seg-${state.currentIndex}-char-${charIdx}`);
                if(el) el.classList.add('reading-active');
                return;
            }
            state.isJumping = true; window.stopSpeaking();
            document.querySelectorAll('.char-box').forEach(s => s.classList.remove('reading-active', 'reading-past'));
            setTimeout(() => { 
                state.isJumping = false; 
                const unit = findUnitBounds(charIdx, state.clickMode); 
                state.speechOffset = unit.start; 
                speakTextData(unit.text, unit.start, state.clickMode); 
            }, 50);
        };

        window.toggleAutoPlay = () => {
            state.isAutoPlay = !state.isAutoPlay;
            const btn = document.getElementById('autoplay-btn');
            if(state.isAutoPlay) btn.classList.add('bg-indigo-50', 'text-indigo-600', 'border-indigo-500', 'ring-2', 'ring-indigo-200');
            else btn.className = 'bg-white border border-slate-300 text-slate-500 hover:text-indigo-600 hover:border-indigo-300 px-4 py-2 rounded-lg shadow-sm transition-all active:scale-95 flex items-center gap-2';
        };
        
        // 確保這兩個函數被正確定義在 window 對象上
        window.nextItem = () => { 
            if (state.currentIndex < state.segments.length - 1) { 
                window.stopSpeaking(); 
                state.currentIndex++; 
                renderContent(false); 
                window.clearInput(); 
            } 
        };
        
        window.prevItem = () => { 
            if (state.currentIndex > 0) { 
                window.stopSpeaking(); 
                state.currentIndex--; 
                renderContent(false); 
                window.clearInput(); 
            } 
        };
        
        window.setMode = (mode) => {
            window.stopSpeaking(); state.mode = mode; window.parseContent(); window.clearInput();
            document.querySelectorAll('.mode-tab').forEach(btn => { btn.className = `mode-tab flex-1 py-3 text-sm font-medium transition-colors border-b-2 ${btn.dataset.mode === mode ? 'text-indigo-600 border-indigo-600 bg-indigo-50' : 'text-slate-500 border-transparent'}`; });
        };
        window.setClickMode = (mode) => {
            state.clickMode = mode;
            const colors = { sentence: 'indigo', phrase: 'amber', word: 'green', silent: 'yellow' };
            ['sentence', 'phrase', 'word', 'silent'].forEach(k => {
                const btn = document.getElementById(`btn-mode-${k}`);
                const c = colors[k];
                btn.className = `p-1.5 rounded transition-colors ${k===mode ? `text-${c}-600 bg-${c}-50 font-bold ring-1 ring-${c}-200` : 'text-slate-400 hover:text-indigo-600 hover:bg-slate-50'}`;
            });
            const spans = document.querySelectorAll('.segment-wrapper'); 
            spans.forEach(span => {
                span.classList.remove('hover-sentence', 'hover-phrase', 'hover-word', 'hover-silent');
                if (mode === 'sentence') span.classList.add('hover-sentence');
                else if (mode === 'phrase') span.classList.add('hover-phrase');
                else if (mode === 'word') span.classList.add('hover-word');
                else if (mode === 'silent') span.classList.add('hover-silent');
            });
        };
        window.changeFontSize = (delta) => {
            state.fontSize = Math.max(16, Math.min(64, state.fontSize + delta));
            const displayEl = document.getElementById('font-display-val');
            if(displayEl) displayEl.textContent = state.fontSize;
            document.getElementById('content-container').style.fontSize = `${state.fontSize}px`;
            setTimeout(resizeAllCanvases, 50);
        };
        window.toggleLibraryPanel = () => document.getElementById('library-panel').classList.toggle('hidden');
        window.toggleImportPanel = () => { const p = document.getElementById('import-panel'); if(p.classList.contains('hidden')){ document.getElementById('import-textarea').value = state.fullText; p.classList.remove('hidden'); } else p.classList.add('hidden'); };
        window.clearImportArea = () => document.getElementById('import-textarea').value = '';
        window.clearInput = () => { document.getElementById('student-input').value = ''; window.resetTimer(); document.getElementById('analysis-panel').classList.add('hidden'); };
        window.showToast = (msg, type='info') => {
            const el = document.createElement('div');
            el.className = `toast ${type==='error'?'bg-red-500 text-white':type==='success'?'bg-emerald-600 text-white':'bg-slate-800 text-white'} px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 pointer-events-auto`;
            el.innerHTML = type==='success' ? `<i data-lucide="check-circle" class="w-4 h-4"></i> ${msg}` : (type==='error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : msg);
            document.getElementById('toast-container').appendChild(el); lucide.createIcons();
            setTimeout(() => { el.classList.add('hiding'); setTimeout(() => el.remove(), 300); }, 3000);
        };
        window.showDialog = ({ title, message, type='alert', defaultValue='' }) => new Promise(resolve => {
            const m = document.getElementById('custom-dialog');
            document.getElementById('dialog-title').textContent = title; document.getElementById('dialog-message').textContent = message;
            const inp = document.getElementById('dialog-input'); const btns = document.getElementById('dialog-buttons');
            inp.value = defaultValue; inp.classList.add('hidden'); if(type==='input'){ inp.classList.remove('hidden'); setTimeout(()=>inp.focus(),100); }
            btns.innerHTML = '';
            const cancel = document.createElement('button'); cancel.className = "px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"; cancel.textContent = "取消"; cancel.onclick = () => { close(); resolve(type==='input'?null:false); };
            const confirm = document.createElement('button'); confirm.className = "px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-md"; confirm.textContent = "確認"; confirm.onclick = () => { const v = type==='input'?inp.value:true; if(type==='input'&&!v.trim())return; close(); resolve(v); };
            if(type!=='alert') btns.appendChild(cancel); btns.appendChild(confirm); m.classList.remove('hidden'); function close(){ m.classList.add('hidden'); }
        });
        window.analyzeResult = () => {
            const student = document.getElementById('student-input').value.replace(/\s+/g, '');
            // When analyzing, we need to compare against the *raw text* without [sound] overrides.
            // state.segments contains the rich format "Char(Zhuyin)[Sound]".
            // We need to strip (..) and [..] to get pure text for comparison.
            const rawSeg = state.segments[state.currentIndex];
            const original = rawSeg.replace(/\(.*?\)/g, "").replace(/\[.*?\]/g, "").replace(/[，。！？、：；]/g, '').replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "");
            
            const cleanStudent = student.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, "");
            const dmp = new diff_match_patch(); const diffs = dmp.diff_main(original, cleanStudent); dmp.diff_cleanupSemantic(diffs);
            let correct = 0; let html = ''; diffs.forEach(part => { const [type, txt] = part; if (type === 0) { correct += txt.length; html += `<span class="text-green-700">${txt}</span>`; } else if (type === -1) html += `<span class="bg-red-100 text-red-600 line-through decoration-red-400 decoration-2 px-0.5 rounded">${txt}</span>`; else html += `<span class="bg-yellow-100 text-yellow-700 px-0.5 rounded">${txt}</span>`; });
            const acc = original.length ? Math.round((correct / original.length) * 100) : 0; const cpm = state.recordingTime > 0 ? Math.round(cleanStudent.length / (state.recordingTime/60)) : 0;
            state.results[state.currentIndex] = { accuracy: acc, cpm, html, studentText: document.getElementById('student-input').value, originalText: original };
            updateSessionStats();
            document.getElementById('accuracy-score').textContent = `${acc}%`; document.getElementById('speed-score').innerHTML = `${cpm} <span class="text-sm">字/分</span>`; document.getElementById('diff-output').innerHTML = html; document.getElementById('analysis-panel').classList.remove('hidden'); document.getElementById('analysis-panel').scrollIntoView({ behavior: 'smooth' });
        };
        window.togglePracticeMode = () => {
            state.isPracticeOpen = !state.isPracticeOpen; const rightPanel = document.getElementById('right-panel'); const btn = document.getElementById('practice-toggle-btn');
            if (state.isPracticeOpen) { rightPanel.classList.remove('hidden'); rightPanel.classList.add('flex'); btn.innerHTML = '<i data-lucide="mic-off" class="w-4 h-4"></i> 關閉朗讀區'; btn.className = "ml-2 flex items-center gap-2 px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-sm font-medium transition-colors border border-emerald-600 shadow-sm"; }
            else { rightPanel.classList.add('hidden'); rightPanel.classList.remove('flex'); btn.innerHTML = '<i data-lucide="mic" class="w-4 h-4"></i> 開啟學生朗讀區'; btn.className = "ml-2 flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-lg text-sm font-medium transition-colors border border-emerald-200 shadow-sm"; }
            lucide.createIcons();
        };
        window.handleFileUpload = async (input) => {
            const file = input.files[0]; if (!file) return; const loadingEl = document.getElementById('file-loading'); loadingEl.classList.remove('hidden');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = "處理中...";
            try {
                if (file.type === 'application/pdf') { 
                    const b = await file.arrayBuffer(); 
                    const pdf = await pdfjsLib.getDocument({data:b}).promise; 
                    let t=""; 
                    for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const c=await p.getTextContent();t+=c.items.map(s=>s.str).join('')+"\n\n";} 
                    document.getElementById('import-textarea').value=t.trim(); 
                } else if (file.type === 'text/plain') { 
                    const t = await file.text(); 
                    document.getElementById('import-textarea').value=t.trim(); 
                } else if (file.name.endsWith('.docx')) { // Handle .docx
                    await processWordFile(file);
                } else if (file.type.startsWith('image/')) {
                    loadingText.textContent = "辨識中...";
                    await processImageWithOCR(file);
                }
            } catch(e) { 
                console.error(e);
                window.showToast("讀取失敗: " + e.message, "error"); 
            } finally { 
                loadingEl.classList.add('hidden'); 
                input.value = ''; 
            }
        };
        window.confirmImport = () => { const text = document.getElementById('import-textarea').value.trim(); if (!text) { window.showToast("內容不能為空", "error"); return; } state.fullText = text; window.setMode(state.mode); window.toggleImportPanel(); window.clearInput(); };
        window.parseContent = () => {
            const text = state.fullText;
            if (state.mode === 'article' || state.mode === 'paragraph') { 
                state.segments = text.split(/\r?\n+/).filter(s => s.trim().length > 0); 
                if(!state.segments.length) state.segments = [text]; 
            }
            else { 
                state.segments = text.split(/([。！？!?])/).filter(Boolean); 
                let n=[]; 
                for(let i=0;i<state.segments.length;i+=2){ 
                    n.push(state.segments[i].trim()+(state.segments[i+1]||'')); 
                } 
                state.segments = n.length ? n : [text]; 
            }
            state.results = new Array(state.segments.length).fill(null); 
            state.currentIndex = 0; 
            renderContent(true); 
            updateSessionStats();
        };
        window.downloadPdf = () => { 
            const el = document.getElementById('full-report-container'); 
            const done = state.results.filter(r => r); 
            const date = new Date().toLocaleString('zh-TW'); 
            const avg = done.length ? Math.round(done.reduce((a,c)=>a+c.accuracy,0)/done.length) : 0; 
            const styles = `
                <style>
                    body { font-family: 'Noto Sans TC', sans-serif; color: #1f2937; }
                    .report-header { margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
                    .report-title { color: #4f46e5; font-size: 24px; font-weight: bold; margin: 0; }
                    .report-meta { color: #6b7280; font-size: 14px; margin-top: 5px; }
                    .report-item { margin-bottom: 15px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #fff; page-break-inside: avoid; }
                    .item-header { font-weight: bold; color: #374151; margin-bottom: 8px; display: flex; justify-content: space-between; border-bottom: 1px dashed #f3f4f6; padding-bottom: 5px; }
                    .item-content { line-height: 1.8; font-size: 16px; }
                    .text-green-700 { color: #15803d !important; font-weight: bold; }
                    .bg-red-100 { background-color: #fee2e2 !important; }
                    .text-red-600 { color: #dc2626 !important; }
                    .line-through { 
                        text-decoration: none !important; 
                        background-image: linear-gradient(to bottom, transparent 45%, #dc2626 45%, #dc2626 55%, transparent 55%) !important;
                        background-size: 100% 100%;
                        background-repeat: no-repeat;
                        display: inline-block;
                    }
                    .bg-yellow-100 { background-color: #fef9c3 !important; }
                    .text-yellow-700 { color: #a16207 !important; }
                    .rounded { border-radius: 0.25rem !important; }
                    .px-0\\.5 { padding-left: 0.125rem !important; padding-right: 0.125rem !important; }
                </style>
            `;
            let html = `${styles}
            <div style="padding: 20px; font-family: 'Noto Sans TC', sans-serif;">
                <div class="report-header"><h1 class="report-title">課文朗讀檢核報告</h1><div class="report-meta"><span>時間：${date}</span><span style="margin-left: 20px;">平均正確率：<span style="color:${avg>=80?'#15803d':'#dc2626'}; font-weight:bold; font-size: 1.2em;">${avg}%</span></span></div></div>`;
            done.forEach((r,i) => {
                html += `<div class="report-item"><div class="item-header"><span>句 #${i+1}</span><span style="color:${r.accuracy>=80?'#15803d':'#dc2626'}">正確率：${r.accuracy}% | 語速：${r.cpm} 字/分</span></div><div class="item-content">${r.html}</div></div>`;
            }); 
            html += `</div>`; 
            el.innerHTML = html; 
            el.classList.remove('hidden'); 
            const opt = {
                margin:       10,
                filename:     `reading_report_${new Date().getTime()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            html2pdf().set(opt).from(el).save().then(() => el.classList.add('hidden')); 
        };
        window.downloadTxtReport = () => { const done = state.results.filter(r => r); let txt = `【朗讀報告】\n時間: ${new Date().toLocaleString()}\n`; done.forEach((r,i) => txt += `#${i+1} [${r.accuracy}%]\n原文: ${r.originalText}\n朗讀: ${r.studentText}\n\n`); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'})); a.download = 'report.txt'; a.click(); };
        window.saveToLibraryFromEditor = async () => { 
            const text = document.getElementById('import-textarea').value.trim(); 
            if (!text) { window.showToast("內容為空，無法儲存！", "error"); return; } 
            if (!currentUser) { window.showToast("請先登入", "error"); return; } 
            const title = await window.showDialog({ title: "儲存", message: "請輸入標題：", type: 'input', defaultValue: "未命名教材" }); 
            if (!title) return; 
            const currentSettings = { fontSize: state.fontSize, voiceRate: state.voiceRate, voiceName: document.getElementById('voice-select').value };
            try { 
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'textbooks', title.trim()), { title: title.trim(), content: text, drawings: state.drawings, polyphones: state.polyphones, settings: currentSettings, updatedAt: new Date().toISOString() }); 
                window.showToast("儲存成功", "success"); 
            } catch (e) { window.showToast("儲存失敗", "error"); } 
        };
        window.deleteFromLibrary = async (id) => { if (await window.showDialog({ title: "刪除", message: `確定刪除「${id}」？`, type: 'confirm' })) { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'textbooks', id)); window.showToast("已刪除", "success"); } catch(e) { window.showToast("刪除失敗", "error"); } } };
        window.loadFromLibrary = (content, drawings, polyphones, settings) => { 
            state.fullText = content; 
            state.drawings = drawings || {}; 
            state.polyphones = polyphones || {}; 
            if (settings) {
                if (settings.fontSize) { state.fontSize = settings.fontSize; document.getElementById('content-container').style.fontSize = `${state.fontSize}px`; }
                if (settings.voiceRate) { state.voiceRate = settings.voiceRate; document.getElementById('rate-range').value = state.voiceRate; }
            }
            renderPolyphones();
            window.setMode(state.mode); 
            window.toggleLibraryPanel(); 
            if (!document.getElementById('import-panel').classList.contains('hidden')) { document.getElementById('import-textarea').value = state.fullText; window.toggleImportPanel(); } 
            window.clearInput(); 
            window.showToast("已載入", "success"); 
        };
        function setupLibraryListener(uid) {
            const q = query(collection(db, 'artifacts', appId, 'users', uid, 'textbooks'), orderBy('updatedAt', 'desc'));
            document.getElementById('library-loading').classList.remove('hidden');
            document.getElementById('library-empty-state').classList.add('hidden');
            document.getElementById('library-list').innerHTML = '';
            libraryUnsubscribe = onSnapshot(q, (snapshot) => {
                const libraryList = document.getElementById('library-list');
                const emptyState = document.getElementById('library-empty-state');
                const loading = document.getElementById('library-loading');
                loading.classList.add('hidden');
                libraryList.innerHTML = '';
                if (snapshot.empty) emptyState.classList.remove('hidden');
                else {
                    emptyState.classList.add('hidden');
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const el = document.createElement('div');
                        el.className = "library-card bg-white border border-slate-200 rounded-xl p-5 flex flex-col h-full relative group";
                        const safeId = docSnap.id.replace(/'/g, "\\'");
                        const drawingsStr = data.drawings ? JSON.stringify(data.drawings).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '{}';
                        const polyStr = data.polyphones ? JSON.stringify(data.polyphones).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '{}';
                        const settingsStr = data.settings ? JSON.stringify(data.settings).replace(/'/g, "\\'").replace(/"/g, '&quot;') : 'null';
                        const safeContent = data.content.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, "\\n");
                        el.innerHTML = `<div class="flex items-start justify-between mb-2"><div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i data-lucide="book" class="w-5 h-5"></i></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.deleteFromLibrary('${safeId}')" class="p-1.5 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-md transition-colors" title="刪除"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><h3 class="font-bold text-slate-800 text-lg mb-2 line-clamp-1">${data.title}</h3><p class="text-slate-500 text-sm mb-4 line-clamp-3 flex-1 leading-relaxed">${data.content.substring(0,50)}...</p><button onclick='window.loadFromLibrary("${safeContent}", ${drawingsStr}, ${polyStr}, ${settingsStr})' class="w-full py-2 bg-slate-50 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 font-medium rounded-lg border border-slate-200 hover:border-indigo-200 transition-all flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i>載入教材</button>`;
                        libraryList.appendChild(el);
                    });
                }
                lucide.createIcons();
            });
        }
        function initSegmentCanvases() {
            document.querySelectorAll('.segment-canvas').forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.lineJoin = 'round'; ctx.lineCap = 'round';
                resizeSegmentCanvas(canvas);
                canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
                canvas.addEventListener('touchstart', (e) => { if (drawingState.active) e.preventDefault(); startDrawing(e.touches[0]); }, { passive: false });
                canvas.addEventListener('touchmove', (e) => { if (drawingState.active) e.preventDefault(); draw(e.touches[0]); }, { passive: false });
                canvas.addEventListener('touchend', stopDrawing);
            });
        }
        function resizeSegmentCanvas(canvas) {
            const wrapper = canvas.parentElement; if(!wrapper) return;
            if (wrapper.offsetWidth === 0 || wrapper.offsetHeight === 0) return;
            canvas.width = wrapper.offsetWidth;
            canvas.height = wrapper.offsetHeight;
            const segIdx = canvas.dataset.segIdx;
            if(state.drawings[segIdx]) {
                const ctx = canvas.getContext('2d');
                state.drawings[segIdx].forEach(path => {
                    ctx.beginPath();
                    path.points.forEach((p, i) => { if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); });
                    if (path.tool === 'pen') { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=path.color; ctx.lineWidth=path.width; ctx.globalAlpha=1; }
                    else if (path.tool === 'highlighter') { ctx.globalCompositeOperation='multiply'; ctx.strokeStyle=path.color==='#000000'?'#fde047':(path.color==='#ef4444'?'#fca5a5':path.color); ctx.lineWidth=path.width*5; ctx.globalAlpha=0.4; }
                    else if (path.tool === 'eraser') { ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=path.width*10; ctx.globalAlpha=1; }
                    ctx.stroke();
                });
            }
        }
        function resizeAllCanvases() { document.querySelectorAll('.segment-canvas').forEach(c => resizeSegmentCanvas(c)); }
        function startDrawing(e) { if(!drawingState.active) return; drawingState.isDrawing = true; drawingState.activeCanvas = e.target; const pos = getPos(e, e.target); drawingState.lastX = pos.x; drawingState.lastY = pos.y; drawingState.currentPath = { tool: drawingState.tool, color: drawingState.color, width: drawingState.lineWidth, points: [{x: pos.x, y: pos.y}] }; }
        function draw(e) { if(!drawingState.isDrawing || !drawingState.active || e.target !== drawingState.activeCanvas) return; const ctx = drawingState.activeCanvas.getContext('2d'); const pos = getPos(e, drawingState.activeCanvas); ctx.beginPath(); ctx.moveTo(drawingState.lastX, drawingState.lastY); ctx.lineTo(pos.x, pos.y); if (drawingState.tool === 'pen') { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=drawingState.color; ctx.lineWidth=drawingState.lineWidth; ctx.globalAlpha=1; } else if (drawingState.tool === 'highlighter') { ctx.globalCompositeOperation='multiply'; ctx.strokeStyle=drawingState.color==='#000000'?'#fde047':(drawingState.color==='#ef4444'?'#fca5a5':drawingState.color); ctx.lineWidth=drawingState.lineWidth*5; ctx.globalAlpha=0.4; } else if (drawingState.tool === 'eraser') { ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=drawingState.lineWidth*10; ctx.globalAlpha=1; } ctx.stroke(); drawingState.lastX = pos.x; drawingState.lastY = pos.y; if(drawingState.currentPath) drawingState.currentPath.points.push({x: pos.x, y: pos.y}); }
        function stopDrawing() { 
            if(drawingState.isDrawing && drawingState.currentPath && drawingState.activeCanvas) { 
                const segIdx = drawingState.activeCanvas.dataset.segIdx; 
                if(!state.drawings[segIdx]) state.drawings[segIdx] = []; 
                state.drawings[segIdx].push(drawingState.currentPath); 
                drawingState.history.push({ segIdx: segIdx, path: drawingState.currentPath });
                drawingState.redoStack = []; 
                window.updateHistoryUI();
            } 
            drawingState.isDrawing = false; 
            drawingState.activeCanvas = null; 
            drawingState.currentPath = null; 
        }
        function getPos(e, canvas) { const rect = canvas.getBoundingClientRect(); const cx = e.clientX || e.pageX; const cy = e.clientY || e.pageY; return { x: cx - rect.left, y: cy - rect.top }; }
        window.clearAllCanvas = () => { 
            state.drawings = {}; 
            drawingState.history = []; 
            drawingState.redoStack = [];
            document.querySelectorAll('.segment-canvas').forEach(c => c.getContext('2d').clearRect(0,0,c.width,c.height)); 
            window.updateHistoryUI(); 
        };
        window.toggleDrawingMode = () => { drawingState.active = !drawingState.active; const btn = document.getElementById('drawing-toggle-btn'); const toolbar = document.getElementById('drawing-toolbar'); const left = document.getElementById('left-panel'); if(drawingState.active) { btn.classList.add('bg-indigo-50','text-indigo-600','border-indigo-300'); btn.classList.remove('bg-white','text-slate-600','border-slate-300'); toolbar.classList.remove('hidden'); left.classList.add('drawing-mode-active'); resizeAllCanvases(); window.updateHistoryUI(); } else { btn.classList.remove('bg-indigo-50','text-indigo-600','border-indigo-300'); btn.classList.add('bg-white','text-slate-600','border-slate-300'); toolbar.classList.add('hidden'); left.classList.remove('drawing-mode-active'); } };
        window.setTool = (t) => { drawingState.tool = t; ['pen','highlighter','eraser'].forEach(i => { const el=document.getElementById(`tool-${i}`); if(i===t) el.className="p-2 rounded-md bg-white text-indigo-600 shadow-sm"; else el.className="p-2 rounded-md text-slate-500 hover:text-indigo-600 hover:bg-white/50"; }); };
        window.setColor = (c) => { drawingState.color = c; document.getElementById('color-picker').value = c; if(drawingState.tool==='eraser') window.setTool('pen'); };
        window.setLineWidth = (w) => { drawingState.lineWidth = parseInt(w); };
        window.undo = () => {
            if (drawingState.history.length === 0) return;
            const lastAction = drawingState.history.pop();
            drawingState.redoStack.push(lastAction);
            const segIdx = lastAction.segIdx;
            const pathIndex = state.drawings[segIdx].indexOf(lastAction.path);
            if (pathIndex > -1) { state.drawings[segIdx].splice(pathIndex, 1); }
            const canvas = document.getElementById(`canvas-${segIdx}`);
            if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); resizeSegmentCanvas(canvas); }
            window.updateHistoryUI();
        };
        window.redo = () => {
            if (drawingState.redoStack.length === 0) return;
            const action = drawingState.redoStack.pop();
            drawingState.history.push(action);
            const segIdx = action.segIdx;
            state.drawings[segIdx].push(action.path);
            const canvas = document.getElementById(`canvas-${segIdx}`);
            if(canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); resizeSegmentCanvas(canvas); }
            window.updateHistoryUI();
        };
        window.toggleLegend = () => document.getElementById('legend-modal').classList.toggle('hidden');
        async function initApp() {
            lucide.createIcons(); loadVoices();
            try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch (e) { window.showToast("登入失敗", "error"); }
            onAuthStateChanged(auth, (user) => { currentUser = user; if (user) setupLibraryListener(user.uid); else if(libraryUnsubscribe) libraryUnsubscribe(); });
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition(); recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'zh-TW';
                recognition.onresult = (e) => { let f='', i=''; for(let j=e.resultIndex; j<e.results.length; ++j) { if(e.results[j].isFinal) f+=e.results[j][0].transcript; else i+=e.results[j][0].transcript; } if(f) { const el=document.getElementById('student-input'); el.value+=f; el.scrollTop=el.scrollHeight; } const l=document.getElementById('live-transcript'); if(i) { l.textContent=i; l.classList.add('text-indigo-600'); } };
                recognition.onerror = (e) => { if(e.error==='not-allowed') { state.isRecording=false; window.stopTimer(); updateRecordingUI(false); window.showToast("麥克風被拒", "error"); } };
                recognition.onend = () => { if(state.isRecording) setTimeout(() => { if(state.isRecording) try{recognition.start();}catch(e){} }, 200); };
            }
            window.addEventListener('resize', () => resizeAllCanvases());
            const slider = document.getElementById('rate-range');
            const display = document.getElementById('rate-value');
            if(slider && display) { slider.addEventListener('input', (e) => { display.textContent = e.target.value; state.voiceRate = e.target.value; }); }
            window.addEventListener('paste', async (e) => {
                const importPanel = document.getElementById('import-panel');
                if (importPanel.classList.contains('hidden')) return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        const loadingEl = document.getElementById('file-loading');
                        loadingEl.classList.remove('hidden');
                        document.getElementById('loading-text').textContent = "辨識截圖中...";
                        try { await processImageWithOCR(blob); } catch(err) { window.showToast("圖片辨識失敗", "error"); } finally { loadingEl.classList.add('hidden'); }
                    }
                }
            });
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
        initApp();
        window.setMode('sentence'); window.setClickMode('sentence');
    </script>
</body>
</html>